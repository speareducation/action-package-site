---
name: "Package Spear Site"
author: "Kenzi Stewart <kstewart@speareducation.com>"
description: "Packages a site into a deployable docker image"
inputs:
  aws-access-key-id:
    description: Amazon Access Key with permission to modify the ECR repository
    required: true
  aws-secret-access-key:
    description: Amazon Secret Access Key
    required: true
  aws-session-token:
    description: AWS Session token (if applicable)
    required: false
  aws-region:
    description: Region of AWS ECR repository
    required: false
    default: us-east-1
  ecr-registry:
    description: 12-digit ID of ECR registry
    required: true
  ecr-repo:
    description: Name of ECR repository to act upon
    required: true
  git-ref:
    description: Git Ref to build
    required: true
  node-auth-token:
    description: Auth token for node packages
    required: true
runs:
  using: "composite"
  steps:
    - name: Package site
      shell: bash
      run: |
        set -ex
        set -a
        . .buildconfig
        set +a
        AWS_SESSION_TOKEN="${{ inputs.aws-session-token }}"
        BUILD_ARG_AWS_TOKEN=
        if [[ -n ${AWS_SESSION_TOKEN} ]]; then
          BUILD_ARG_AWS_TOKEN="--build-arg AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}"
        fi
        TARGET_IMAGE_VERSION=$(echo "${{ inputs.git-ref }}" | sed -e 's%refs/tags/%%g' -e "s%^v%%g" -e "s%refs/heads/%%g" -e "s%features/%%g" -e "s%releases/%%g" -e "s%/%-%g")
        DOCKERFILE_CONTENTS="QVJHIERPQ0tFUl9CQVNFX0lNQUdFCgpGUk9NICR7RE9DS0VSX0JBU0VfSU1BR0V9CgpBUkcgQVdTX0FDQ0VTU19LRVlfSUQKQVJHIEFXU19TRUNSRVRfQUNDRVNTX0tFWQpBUkcgQVdTX1NFU1NJT05fVE9LRU4KQVJHIEdJVEhVQl9UT0tFTgpBUkcgTk9ERV9BVVRIX1RPS0VOCgpSVU4gc2V0IC14ZSAmJiBcCiAgICBta2RpciAtcCAvcm9vdC8uc3NoICYmIFwKICAgIGFwayBhZGQgZ2V0dGV4dCAmJiBcCiAgICBleHBvcnQgR0lUX1NTSF9DT01NQU5EPSdzc2ggLWkgL3Jvb3QvLnNzaC9pZF9yc2EgLW8gVXNlcktub3duSG9zdHNGaWxlPS9kZXYvbnVsbCAtbyBTdHJpY3RIb3N0S2V5Q2hlY2tpbmc9bm8nICYmIFwKICAgIHNzaC1rZXlzY2FuIGdpdGh1Yi5jb20gPj4gL3Jvb3QvLnNzaC9rbm93bl9ob3N0cwoKUlVOIHNldCAteGUgJiYgXAogICAgZXhwb3J0IEFXU19BQ0NFU1NfS0VZX0lEPSRBV1NfQUNDRVNTX0tFWV9JRCAmJiBcCiAgICBleHBvcnQgQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZPSRBV1NfU0VDUkVUX0FDQ0VTU19LRVkgJiYgXAogICAgZXhwb3J0IEFXU19TRVNTSU9OX1RPS0VOPSRBV1NfU0VTU0lPTl9UT0tFTiAmJiBcCiAgICBlY2hvICJSZXF1ZXN0aW5nIHNzaCBrZXlzIGZvciBnaXRodWIgZnJvbSBBV1MgU2VjcmV0c21hbmFnZXIuIiAmJiBcCiAgICBpZiBbWyAieCR7QVdTX1NFU1NJT05fVE9LRU59IiA9PSAieCIgXV07IHRoZW4gdW5zZXQgQVdTX1NFU1NJT05fVE9LRU47IGZpOyBcCiAgICBta2RpciAtcCAvcm9vdC8uc3NoICYmIFwKICAgIGVjaG8gIlJlcXVlc3Rpbmcgc3NoIGtleXMgZm9yIGdpdGh1YiBmcm9tIEFXUyBTZWNyZXRzbWFuYWdlci4iICYmIFwKICAgIGF3cyAtLXJlZ2lvbj0iJHtBV1NfUkVHSU9OOi11cy1lYXN0LTF9IiBzZWNyZXRzbWFuYWdlciBnZXQtc2VjcmV0LXZhbHVlIC0tc2VjcmV0LWlkICJkcm9uZS9naXRodWJfc3NoX2tleSIgfCBcCiAgICAgICAganEgLXIgJy5TZWNyZXRTdHJpbmcgfCBmcm9tanNvbi5naXRodWJfc3NoX2tleScgfCBiYXNlNjQgLWQgPiAvcm9vdC8uc3NoL2lkX3JzYSAmJiBcCiAgICBhd3MgLS1yZWdpb249IiR7QVdTX1JFR0lPTjotdXMtZWFzdC0xfSIgc2VjcmV0c21hbmFnZXIgZ2V0LXNlY3JldC12YWx1ZSAtLXNlY3JldC1pZCAiZHJvbmVfYml0YnVja2V0IiB8IFwKICAgICAgICBqcSAtciAnLlNlY3JldFN0cmluZyB8IGZyb21qc29uLmJpdGJ1Y2tldF9yc2EnIHwgYmFzZTY0IC1kID4gL3Jvb3QvLnNzaC9pZF9yc2FfYml0YnVja2V0ICYmIFwKICAgIGNhdCAvcm9vdC8uc3NoL2lkX3JzYV9iaXRidWNrZXQgJiYgXAogICAgY2htb2QgLVIgZ28tcnd4IC9yb290Ly5zc2ggJiYgXAogICAgZXhwb3J0IEdJVF9TU0hfQ09NTUFORD0nc3NoIC1pIC9yb290Ly5zc2gvaWRfcnNhIC1vIFVzZXJLbm93bkhvc3RzRmlsZT0vZGV2L251bGwgLW8gU3RyaWN0SG9zdEtleUNoZWNraW5nPW5vJyAmJiBcCiAgICBzc2gta2V5c2NhbiBnaXRodWIuY29tID4+IC9yb290Ly5zc2gva25vd25faG9zdHMgJiYgXAogICAgc3NoLWtleXNjYW4gYml0YnVja2V0Lm9yZyA+PiAvcm9vdC8uc3NoL2tub3duX2hvc3RzICYmIFwKICAgIGF3cyAtLXJlZ2lvbj11cy1lYXN0LTEgc2VjcmV0c21hbmFnZXIgZ2V0LXNlY3JldC12YWx1ZSAtLXNlY3JldC1pZCAiZHJvbmUvZ2l0aHViX3NzaF9rZXkiIHwgXAogICAgICAgIGpxIC1yICcuU2VjcmV0U3RyaW5nIHwgZnJvbWpzb24uZ2l0aHViX3NzaF9rZXknIHwgYmFzZTY0IC1kID4gL3Jvb3QvLnNzaC9pZF9yc2EgJiYgXAogICAgeyBcCiAgICAgIGVjaG8gIkhvc3QgYml0YnVja2V0Lm9yZyI7IFwKICAgICAgZWNobyAiICBJZGVudGl0eUZpbGUgL3Jvb3QvLnNzaC9pZF9yc2FfYml0YnVja2V0IjsgXAogICAgICBlY2hvICJIb3N0IGdpdGh1Yi5jb20iOyBcCiAgICAgIGVjaG8gIiAgSWRlbnRpdHlGaWxlIC9yb290Ly5zc2gvaWRfcnNhIjsgXAogICAgfSA+PiAvcm9vdC8uc3NoL2NvbmZpZyAmJiBcCiAgICBjaG1vZCAtUiBnby1yd3ggL3Jvb3QvLnNzaCAmJiBcCiAgICBleHBvcnQgQ09NUE9TRVJfQVBJX0tFWT0kKC91c3IvYmluL2F3cyAtLXJlZ2lvbj0iJHtBV1NfUkVHSU9OOi11cy1lYXN0LTF9IiBzZWNyZXRzbWFuYWdlciBnZXQtc2VjcmV0LXZhbHVlIC0tc2VjcmV0LWlkPWdpdGh1Yi9zcGVhcmVkdWNhdGlvbi9jb3JlIHwganEgLXIgJy5TZWNyZXRTdHJpbmcnIHwganEgLXIgJy5DT01QT1NFUl9BUElfS0VZJykgJiYgXAogICAgbWtkaXIgLXAgfi8uY29tcG9zZXI7IHRvdWNoIH4vLmNvbXBvc2VyL2NvbmZpZy5qc29uICYmIFwKICAgIGVjaG8gIntcInJlcG9zaXRvcmllc1wiOlt7XCJ0eXBlXCI6XCJjb21wb3NlclwiLFwidXJsXCI6XCJodHRwczovL3BhY2thZ2VzLnNwZWFyZWR1Y2F0aW9uLmNvbS9jb21wb3NlclwiLFwib3B0aW9uc1wiOntcImh0dHBcIjp7XCJoZWFkZXJcIjpbXCJ4LWFwaS1rZXk6ICR7Q09NUE9TRVJfQVBJX0tFWX1cIl19fX1dfSIgPiB+Ly5jb21wb3Nlci9jb25maWcuanNvbgoKUlVOIHNldCAteGUgJiYgXAogICAgZWNobyAiUmVtb3Zpbmcgc3RhbGUgL3Zhci93d3cvaHRtbCBkaXIgaWYgaXQgZXhpc3RzIiAmJiBcCiAgICBjZCAvdmFyL3d3dyAmJiBcCiAgICBybSAtcmYgL3Zhci93d3cvaHRtbCAmJiBcCiAgICBta2RpciAtcCAvdmFyL3d3dy9odG1sCgpDT1BZIC4gL3Zhci93d3cvaHRtbAoKUlVOIHNldCAteGUgJiYgXAogICAgZWNobyAiTG9hZGluZyBidWlsZCBjb25maWd1cmF0aW9uIGZyb20gLmJ1aWxkY29uZmlnIiAmJiBcCiAgICBbWyAtZiAuLy5idWlsZGNvbmZpZyBdXSAmJiAuIC4vLmJ1aWxkY29uZmlnICYmIFwKICAgIGlmIFtbIC1mIC92YXIvd3d3L2h0bWwvLmVudi5kcm9uZSBdXTsgdGhlbiBcCiAgICAgICAgLiAvdmFyL3d3dy9odG1sLy5lbnYuZHJvbmU7IFwKICAgIGZpOyBcCiAgICBleHBvcnQgQUxHT0xJQV9NQUlOX0lEPTAwMDAwMDAwMDAgJiYgXAogICAgZXhwb3J0IEFMR09MSUFfTUFJTl9LRVk9MDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAgJiYgXAogICAgZXhwb3J0IE5PREVfQVVUSF9UT0tFTj0iJHtOT0RFX0FVVEhfVE9LRU59IiAmJiBcCiAgICBlY2hvIC1uICJDaGVja2luZyBmb3Igbm9kZSBhdXRoIHRva2VuLi4uIiAmJiBcCiAgICBpZiBbWyAieCR7Tk9ERV9BVVRIX1RPS0VOfSIgIT0gIngiIF1dOyB0aGVuIFwKICAgICAgZWNobyAiZm91bmQuIjsgXAogICAgICBlY2hvIC1uICJBZGRpbmcgbm9kZSBhdXRoIHRva2VuIHRvIG5wbXJjLi4uIjsgXAogICAgICB0b3VjaCAiJHtIT01FfS8ubnBtcmMiOyBcCiAgICAgIG5wbSBjb25maWcgc2V0IGFsd2F5cy1hdXRoIHRydWU7IFwKICAgICAgZWNobyAiLy9ucG0ucGtnLmdpdGh1Yi5jb20vOl9hdXRoVG9rZW49JHtOT0RFX0FVVEhfVE9LRU59IiA+PiAiJHtIT01FfS8ubnBtcmMiOyBcCiAgICAgIGNhdCAke0hPTUV9Ly5ucG1yYzsgXAogICAgICBlY2hvICJkb25lLiI7IFwKICAgIGVsc2UgXAogICAgICBlY2hvICJub3QgZm91bmQuIjsgXAogICAgZmkKClJVTiBzZXQgLXhlICYmIFwKICAgIGNkIC92YXIvd3d3L2h0bWwgJiYgXAogICAgbHMgLiAmJiBcCiAgICBtYWtlIGluc3RhbGwKClJVTiBzZXQgLXhlICYmIFwKICAgIGVjaG8gIkNsZWFuaW5nIHVwIHVubmVjZXNzYXJ5IGFydGlmYWN0cyBhZnRlciBidWlsZCIgJiYgXAogICAgcm0gLXJmIC92YXIvd3d3L2h0bWwvbm9kZV9tb2R1bGVzICYmIFwKICAgIHJtIC1yZiAvdmFyL3d3dy9odG1sLy5naXQgJiYgXAogICAgZWNobyAtbiAiQ2hhbmdpbmcgcGVybWlzc2lvbnMgb24gL3Zhci93d3cvaHRtbC4uLiIgJiYgXAogICAgY2hvd24gLVIgd3d3LWRhdGEgL3Zhci93d3cvaHRtbCAmJiBcCiAgICBlY2hvICIgZG9uZS4iCgpSVU4gc2V0IC14ZSAmJiBcCiAgICBlY2hvIC1uICJTZXR0aW5nIGxhcmF2ZWwgbG9nIHRvIHBvaW50IHRvIC9kZXYvc3RkZXJyLi4uIiAmJiBcCiAgICBta2RpciAtcCAvdmFyL2xvZy9odG1sL3N0b3JhZ2UvbG9ncyAmJiBcCiAgICBsbiAtc2ZuIC9kZXYvc3RkZXJyIC92YXIvbG9nL2h0bWwvc3RvcmFnZS9sb2dzL2xhcmF2ZWwubG9nICYmIFwKICAgIGVjaG8gIiBkb25lLiIKClJVTiBzZXQgLXhlICYmIFwKICAgIGVjaG8gLW4gIk91dHB1dHRpbmcgR2l0IGluZm9ybWF0aW9uIHRvIGNvbnRhaW5lci4uLiIgJiYgXAogICAgZWNobyAiJHtHSVRfUkVQT1NJVE9SWX0iIHwgc2VkIC1lICdzL2FjY291bnRzMi9hY2NvdW50cy9nJyAtZSAncy9jdXJyaWN1bHVtL29ubGluZS9nJyAtZSAncy9cLmdpdCQvL2cnID4gL2V0Yy9zcGVhci1yZXBvc2l0b3J5ICYmIFwKICAgIGVjaG8gIiR7R0lUX0JSQU5DSH0iID4gL2V0Yy9zcGVhci1icmFuY2ggJiYgXAogICAgZWNobyAiJHtHSVRfQ09NTUlUfSIgPiAvZXRjL3NwZWFyLWNvbW1pdC1pZCAmJiBcCiAgICBkYXRlID4gL2V0Yy9zcGVhci1idWlsZC1kYXRlICYmIFwKICAgIG1rZGlyIC1wIC92YXIvd3d3L2h0bWwvcHVibGljICYmIFwKICAgIGVjaG8gIiR7R0lUX0JSQU5DSH0iID4gL3Zhci93d3cvaHRtbC9wdWJsaWMvcmVsZWFzZS50eHQgJiYgXAogICAgZWNobyAiIGRvbmUuIgoKUlVOIHNldCAteGUgJiYgXAogICAgZWNobyAtbiAiQ2hlY2tpbmcgZm9yIHNwZWNpYWwgY2FzZXMgKHNwZWFyLXJldmlldykuLi4iICYmIFwKICAgIGlmIFtbICJ4JHtHSVRfUkVQT1NJVE9SWX0iID09ICJ4c3BlYXJlZHVjYXRpb24vc3BlYXItcmV2aWV3IiBdXTsgdGhlbiBcCiAgICAgICAgZWNobyAiIGZvdW5kLiI7IFwKICAgICAgICBlY2hvIC1uICJSZXdyaXRpbmcgY29uZmlncyBmb3Igc3BlYXItcmV2aWV3Li4uIjsgXAogICAgICAgIHNlZCAtaSAub3JpZyAtZSAkJ3MlXCg8VmlydHVhbEhvc3QgXCo6ODA+XCklXFwxXFxcbiAgICBSZWRpcmVjdE1hdGNoIF4vc3BlYXItcmV2aWV3LyguKikvJCAvc3BlYXItcmV2aWV3LyQxXFxcbiAgICBBbGlhcyBcIi9zcGVhci1yZXZpZXdcIiBcIi92YXIvd3d3L2h0bWwvcHVibGljXCIlZycgL2V0Yy9hcGFjaGUyL2NvbmYuZC85OV9kZWZhdWx0LmNvbmYgJiYgXAogICAgICAgIHJtIC1mIC9ldGMvYXBhY2hlMi9jb25mLmQvOTlfZGVmYXVsdC5jb25mLm9yaWc7IFwKICAgIGZpOyBcCiAgICBlY2hvICIgZG9uZS4iCgpSVU4gc2V0IC14ZSAmJiBcCiAgICBleHBvcnQgUEhQX0lOSV9ESVI9L2V0Yy9waHA3ICYmIFwKICAgIGV4cG9ydCBQSFBfQ09ORl9ESVI9JHtQSFBfSU5JX0RJUn0vY29uZi5kICYmIFwKICAgIG1rZGlyIC1wICIke1BIUF9DT05GX0RJUn0iICYmIFwKICAgIGVjaG8gIkNvbmZpZ3VyaW5nIHRhcmdldCBjb250YWluZXIgcGhwIGxpbWl0cy4uLiIgJiYgXAogICAgZXhwb3J0IERPQ0tFUl9QSFBfVVBMT0FEX01BWF9GSUxFU0laRT0ke0RPQ0tFUl9QSFBfVVBMT0FEX01BWF9GSUxFU0laRTotMTI4TX0gJiYgXAogICAgZWNobyAiICBTZXR0aW5nIG1heCB1cGxvYWQgc2l6ZSB0byAke0RPQ0tFUl9QSFBfVVBMT0FEX01BWF9GSUxFU0laRX0iICYmIFwKICAgIGVjaG8gInVwbG9hZF9tYXhfZmlsZXNpemUgPSAke0RPQ0tFUl9QSFBfVVBMT0FEX01BWF9GSUxFU0laRX0iID4+ICIke1BIUF9DT05GX0RJUn0vOTktbGltaXRzLmluaSIgJiYgXAogICAgZXhwb3J0IERPQ0tFUl9QSFBfUE9TVF9NQVhfU0laRT0ke0RPQ0tFUl9QSFBfUE9TVF9NQVhfU0laRTotMTI4TX0gJiYgXAogICAgZWNobyAiICBTZXR0aW5nIG1heCBwb3N0IHNpemUgdG8gJHtET0NLRVJfUEhQX1BPU1RfTUFYX1NJWkV9IiAmJiBcCiAgICBlY2hvICJwb3N0X21heF9zaXplID0gJHtET0NLRVJfUEhQX1BPU1RfTUFYX1NJWkV9IiA+PiAiJHtQSFBfQ09ORl9ESVJ9Lzk5LWxpbWl0cy5pbmkiICYmIFwKICAgIGV4cG9ydCBET0NLRVJfUEhQX01FTU9SWV9MSU1JVD0ke0RPQ0tFUl9QSFBfTUVNT1JZX0xJTUlUOi0xMjhNfSAmJiBcCiAgICBlY2hvICIgIFNldHRpbmcgbWVtb3J5IGxpbWl0IHRvICR7RE9DS0VSX1BIUF9NRU1PUllfTElNSVR9IiAmJiBcCiAgICBlY2hvICJtZW1vcnlfbGltaXQgPSAke0RPQ0tFUl9QSFBfTUVNT1JZX0xJTUlUfSIgPj4gIiR7UEhQX0NPTkZfRElSfS85OS1saW1pdHMuaW5pIiAmJiBcCiAgICBpZiBbWyAtZiAiL3Zhci93d3cvaHRtbC9hcHAtc3VwZXJ2aXNvcmQuY29uZiIgXV07IHRoZW4gXAogICAgZWNobyAiICBEZXRlY3RlZCBzdXBlcnZpc29yZCBhcHAgY29uZmlndXJhdGlvbi4gSW5zdGFsbGluZyBjb25mIGZpbGUuLi4iOyBcCiAgICBta2RpciAtcCAvZXRjL3N1cGVydmlzb3JkL2NvbmYuZDsgXAogICAgY3AgL3Zhci93d3cvaHRtbC9hcHAtc3VwZXJ2aXNvcmQuY29uZiAvZXRjL3N1cGVydmlzb3JkL2NvbmYuZDsgXAogICAgZmk7IFwKICAgIGVjaG8gImRvbmUuIgo="
        echo ${DOCKERFILE_CONTENTS} | base64 -d > ./Dockerfile
        docker build -f /github/actions/action-package-site/Dockerfile \
          --build-arg AWS_ACCESS_KEY_ID="${{ inputs.aws-access-key-id }}" \
          --build-arg AWS_SECRET_ACCESS_KEY="${{ inputs.aws-secret-access-key }}" \
          ${BUILD_ARG_AWS_TOKEN} \
          --build-arg GIT_BRANCH="${TARGET_IMAGE_VERSION}" \
          --build-arg GIT_REPOSITORY="${{ env.GITHUB_REPOSITORY }}" \
          --build-arg ARTIFACT="${{ inputs.ecr-repo }}" \
          --build-arg DOCKER_REGISTRY="${{ inputs.ecr-registry }}" \
          --build-arg DOCKER_BASE_IMAGE="${{ inputs.ecr-registry }}/${DOCKER_BASE_IMAGE_NAME}:${DOCKER_BASE_IMAGE_VER}" \
          --build-arg NODE_AUTH_TOKEN="${{ inputs.node-auth-token }}" \
          -t "${{ inputs.ecr-registry }}/${{ inputs.ecr-repo }}:${TARGET_IMAGE_VERSION}" .
    - name: Test Release Artifact
      shell: bash
      run: |
        set -ex
        TARGET_IMAGE_VERSION=$(echo "${{ inputs.git-ref }}" | sed -e 's%refs/tags/%%g' -e "s%^v%%g" -e "s%refs/heads/%%g" -e "s%features/%%g" -e "s%releases/%%g" -e "s%/%-%g")
        DOCKER_IMAGE_TAG="${{ inputs.ecr-registry }}/${{ inputs.ecr-repo }}:${TARGET_IMAGE_VERSION}"
        TEST_CONFIG_FILE=./test.config.yml
        TEST_CONFIG_CONTENTS="dGVzdHM6CiAgeGRlYnVnX2VuYWJsZWQ6CiAgICBkZXNjcmlwdGlvbjogVmVyaWZ5IHRoYXQgUEhQX0RFQlVHPTEgeWllbGRzIHRoZSB4ZGVidWcgbW9kdWxlIGJlaW5nIGVuYWJsZWQuCiAgICBlbnZpcm9ubWVudDoKICAgICAgUEhQX0RFQlVHOiAxCiAgICAgIEFQUF9FTlY6ICJkZXZlbG9wbWVudCIKICAgIGdvc3NfY29uZmlnOgogICAgICBjb21tYW5kOgogICAgICAgIHBocCAtbSB8IGdyZXAgeGRlYnVnOgogICAgICAgICAgZXhpdC1zdGF0dXM6IDAKICAgICAgICAgIHN0ZG91dDoKICAgICAgICAgICAgLSAieGRlYnVnIgogICAgICAgICAgdGltZW91dDogMTAwMDAKICB4ZGVidWdfZGlzYWJsZWQ6CiAgICBkZXNjcmlwdGlvbjogVmVyaWZ5IHRoYXQgUEhQX0RFQlVHPTAgZGlzYWJsZXMgdGhlIHhkZWJ1ZyBtb2R1bGUuCiAgICBlbnZpcm9ubWVudDoKICAgICAgUEhQX0RFQlVHOiAwCiAgICAgIEFQUF9FTlY6ICJkZXZlbG9wbWVudCIKICAgIGdvc3NfY29uZmlnOgogICAgICBjb21tYW5kOgogICAgICAgIHBocCAtaSB8IGdyZXAgeGRlYnVnOgogICAgICAgICAgZXhpdC1zdGF0dXM6IDAKICAgICAgICAgIHN0ZG91dDoKICAgICAgICAgICAgLSAheGRlYnVnCiAgICAgICAgICB0aW1lb3V0OiAxMDAwMAogIG5ld3JlbGljX2VuYWJsZWQ6CiAgICBkZXNjcmlwdGlvbjogVmVyaWZ5IHRoYXQgcGFzc2luZyBhIGxpY2Vuc2Uga2V5IGFuZCBORVdSRUxJQ19FTkFCTEVEPTEgZW5hYmxlcyB0aGUgbmV3cmVsaWMgbW9kdWxlLgogICAgZW52aXJvbm1lbnQ6CiAgICAgIE5FV1JFTElDX0VOQUJMRUQ6IDEKICAgICAgTkVXUkVMSUNfTElDRU5TRV9LRVk6ICIxMjM0NTY3ODkwIgogICAgICBBUFBfRU5WOiAiZGV2ZWxvcG1lbnQiCiAgICBnb3NzX2NvbmZpZzoKICAgICAgY29tbWFuZDoKICAgICAgICBwaHAgLWk6CiAgICAgICAgICBleGl0LXN0YXR1czogMAogICAgICAgICAgc3Rkb3V0OgogICAgICAgICAgICAtIG5ld3JlbGljCiAgICAgICAgICB0aW1lb3V0OiAxMDAwMAogIG5ld3JlbGljX2Rpc2FibGVkOgogICAgZGVzY3JpcHRpb246IFZlcmlmeSB0aGF0IG5ld3JlbGljIGlzIGRpc2FibGVkIGJ5IGRlZmF1bHQuCiAgICBlbnZpcm9ubWVudDoKICAgICAgQVBQX0VOVjogImRldmVsb3BtZW50IgogICAgZ29zc19jb25maWc6CiAgICAgIGNvbW1hbmQ6CiAgICAgICAgcGhwIC1pOgogICAgICAgICAgZXhpdC1zdGF0dXM6IDAKICAgICAgICAgIHN0ZG91dDoKICAgICAgICAgICAgLSAhbmV3cmVsaWMKICAgICAgICAgIHRpbWVvdXQ6IDEwMDAwCg=="
        echo ${TEST_CONFIG_CONTENTS} | base64 -d > "${TEST_CONFIG_FILE}"

        TEST_NAMES=$(yq -r '.tests | keys[]' < "${TEST_CONFIG_FILE}")
        DGOSS_BIN="./build/dgoss"
        mkdir -p build/goss
        wget -q -O"${BUILD_DIR}/goss-linux-amd64" https://github.com/aelsabbahy/goss/releases/download/v0.3.16/goss-linux-amd64
        wget -q -O"${BUILD_DIR}/dgoss" "https://raw.githubusercontent.com/aelsabbahy/goss/v0.3.16/extras/dgoss/dgoss"
        mkdir -p build
        for TEST_NAME in ${TEST_NAMES}; do
          DOCKER_ARGS=""
          echo "TEST: ${TEST_NAME}"
          echo -n "  "
          yq -r ".tests.${TEST_NAME}.description" < ${TEST_CONFIG_FILE}
          ENV_VARS=$(yq -r ".tests.${TEST_NAME}.environment | keys[]" < "${TEST_CONFIG_FILE}")
          for VAR_NAME in ${ENV_VARS}; do
            VAR_VALUE=$(yq -r ".tests.${TEST_NAME}.environment.${VAR_NAME}" < "${TEST_CONFIG_FILE}")
            DOCKER_ARGS+=" -e ${VAR_NAME}=${VAR_VALUE}"
          done
          yq -Y ".tests.${TEST_NAME}.goss_config" < "${TEST_CONFIG_FILE}" > "build/test-goss.${TEST_NAME}.yml"
          GOSS_FILE="build/test-goss.${TEST_NAME}.yml" ${DGOSS_BIN} run --rm -it ${DOCKER_ARGS} "${DOCKER_IMAGE_TAG}"
        done
    - name: Publish Artifact to ECR
      shell: bash
      run: |
        set -ex
        TARGET_IMAGE_VERSION=$(echo "${{ inputs.git-ref }}" | sed -e 's%refs/tags/%%g' -e "s%^v%%g" -e "s%refs/heads/%%g" -e "s%features/%%g" -e "s%releases/%%g" -e "s%/%-%g")
        docker push "${{ inputs.ecr-registry }}/${{ inputs.ecr-repo }}:${TARGET_IMAGE_VERSION}"
